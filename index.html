<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Benchmark</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.27.0/full/pyodide.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 760px;
      margin: 40px auto;
      padding: 0 20px;
      color: #1a1a1a;
      background: #fff;
    }

    h1 { font-size: 1.5rem; margin-bottom: 4px; }
    p.subtitle { color: #555; margin: 0 0 24px; font-size: 0.95rem; }

    label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; }

    textarea {
      width: 100%;
      height: 160px;
      font-family: ui-monospace, Menlo, monospace;
      font-size: 0.85rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      resize: vertical;
      line-height: 1.5;
    }
    textarea:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 3px rgba(74,144,226,.15); }

    .controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    select {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.9rem;
      background: #fff;
      cursor: pointer;
    }

    button#runBtn {
      padding: 8px 20px;
      font-size: 0.9rem;
      font-weight: 600;
      background: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.15s;
    }
    button#runBtn:hover:not(:disabled) { background: #357abd; }
    button#runBtn:disabled { background: #a0b8d8; cursor: not-allowed; }

    .status {
      font-size: 0.85rem;
      color: #666;
      margin-left: auto;
    }
    .status.ready { color: #2a9d2a; font-weight: 600; }

    .error {
      margin-top: 10px;
      color: #c0392b;
      font-size: 0.875rem;
      min-height: 1.2em;
    }

    #results { margin-top: 28px; display: none; }
    #results h2 { font-size: 1rem; margin-bottom: 10px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th {
      text-align: left;
      padding: 8px 12px;
      background: #f5f5f5;
      border-bottom: 2px solid #ddd;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #555;
    }
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
    }
    tr:last-child td { border-bottom: none; }
    .speedup { font-weight: 700; color: #2a9d2a; }
    .speedup.slow { color: #c0392b; }

    /* spinner */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,.4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .6s linear infinite;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<h1>JSON Benchmark</h1>
<p class="subtitle">Compare <code>json</code> vs <code>ujson</code> — runs entirely in-browser via Pyodide.</p>

<label for="jsonInput">JSON input (dict or list)</label>
<textarea id="jsonInput">{
  "name": "Alice",
  "age": 30,
  "scores": [95, 87, 92, 100, 78],
  "address": {
    "city": "Wonderland",
    "zip": "12345"
  },
  "active": true,
  "ratio": 3.14159
}</textarea>

<div class="controls">
  <label style="margin:0; font-weight:normal; display:flex; align-items:center; gap:8px;">
    Iterations
    <select id="iterations">
      <option value="100">100</option>
      <option value="1000" selected>1000</option>
      <option value="5000">5000</option>
    </select>
  </label>

  <button id="runBtn" disabled>
    <span id="btnLabel">Run Benchmark</span>
  </button>

  <span class="status" id="status">Loading Python runtime…</span>
</div>

<div class="error" id="error"></div>

<div id="results">
  <h2>Results</h2>
  <table>
    <thead>
      <tr>
        <th>Operation</th>
        <th>json (s)</th>
        <th>ujson (s)</th>
        <th>Speedup</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>
</div>

<script>
const BENCH_CODE = `
import json, ujson, timeit

def _bench(mod, obj, n):
    s = mod.dumps(obj)
    mod.dumps(obj)   # warm up
    mod.loads(s)
    d = timeit.timeit(lambda: mod.dumps(obj), number=n)
    l = timeit.timeit(lambda: mod.loads(s), number=n)
    return float(d), float(l)

_native = data.to_py() if hasattr(data, 'to_py') else data
jd, jl = _bench(json,  _native, iterations)
ud, ul = _bench(ujson, _native, iterations)
bench_results = {"jd": jd, "jl": jl, "ud": ud, "ul": ul}
`;

let pyodide = null;

async function init() {
  try {
    pyodide = await loadPyodide();
    await pyodide.loadPackage("micropip");
    const micropip = pyodide.pyimport("micropip");
    await micropip.install("ujson");

    document.getElementById("runBtn").disabled = false;
    const st = document.getElementById("status");
    st.textContent = "Ready";
    st.className = "status ready";
  } catch (e) {
    document.getElementById("status").textContent = "Failed to load runtime.";
    console.error(e);
  }
}

function setRunning(running) {
  const btn = document.getElementById("runBtn");
  const label = document.getElementById("btnLabel");
  btn.disabled = running;
  if (running) {
    const spinner = document.createElement("span");
    spinner.className = "spinner";
    spinner.id = "spinner";
    btn.insertBefore(spinner, label);
    label.textContent = "Running…";
  } else {
    const sp = document.getElementById("spinner");
    if (sp) sp.remove();
    label.textContent = "Run Benchmark";
  }
}

function showError(msg) {
  document.getElementById("error").textContent = msg;
}

function renderResults(jd, jl, ud, ul) {
  const tbody = document.getElementById("resultsBody");
  tbody.innerHTML = "";

  const rows = [
    { op: "dumps", j: jd, u: ud },
    { op: "loads", j: jl, u: ul },
  ];

  for (const { op, j, u } of rows) {
    const speedup = j / u;
    const tr = document.createElement("tr");
    const cls = speedup >= 1 ? "speedup" : "speedup slow";
    const label = speedup >= 1
      ? `${speedup.toFixed(2)}x faster`
      : `${(1/speedup).toFixed(2)}x slower`;

    tr.innerHTML = `
      <td>${op}</td>
      <td>${j.toFixed(6)}</td>
      <td>${u.toFixed(6)}</td>
      <td class="${cls}">${label}</td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById("results").style.display = "block";
}

document.getElementById("runBtn").addEventListener("click", () => {
  showError("");

  const raw = document.getElementById("jsonInput").value.trim();
  let parsed;
  try {
    parsed = JSON.parse(raw);
  } catch (e) {
    showError("JSON parse error: " + e.message);
    return;
  }

  const iterations = parseInt(document.getElementById("iterations").value, 10);

  setRunning(true);

  // yield to browser so spinner renders before the blocking WASM call
  setTimeout(async () => {
    try {
      pyodide.globals.set("data", pyodide.toPy(parsed));
      pyodide.globals.set("iterations", iterations);
      await pyodide.runPythonAsync(BENCH_CODE);

      const r = pyodide.globals.get("bench_results").toJs();
      renderResults(r.get("jd"), r.get("jl"), r.get("ud"), r.get("ul"));
    } catch (e) {
      showError("Benchmark error: " + e.message);
      console.error(e);
    } finally {
      setRunning(false);
    }
  }, 30);
});

init();
</script>
</body>
</html>
